<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backed Up Email Explorer</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            position: relative;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .filter-bar {
            margin-bottom: 20px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filter-bar label {
            font-weight: bold;
            color: #34495e;
            display: inline-block;
        }
        .filter-bar input[type="text"],
        .filter-bar input[type="date"],
        .filter-bar select,
        .filter-bar button {
            padding: 10px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            flex-basis: 150px;
            flex-grow: 1;
            min-width: 100px;
        }
         .filter-bar button {
             flex-grow: 0;
             flex-shrink: 0;
             flex-basis: auto;
             min-width: auto;
             background-color: #3498db;
             color: white;
             cursor: pointer;
             transition: background-color 0.3s ease;
             font-weight: bold;
         }

         .filter-bar select {
             cursor: pointer;
         }
        .filter-bar button:hover {
            background-color: #2980b9;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
         .pagination button {
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: #ffffff;
            color: #34495e;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
             font-weight: bold;
        }
        .pagination button#prevPageBtn, 
        .pagination button#nextPageBtn,
        .pagination button#prevPageBtn2,
        .pagination button#nextPageBtn2 {
            background-color: #3498db;
            color: white;
        }
         .pagination button#prevPageBtn:hover:not(:disabled), 
         .pagination button#nextPageBtn:hover:not(:disabled),
         .pagination button#prevPageBtn2:hover:not(:disabled),
         .pagination button#nextPageBtn2:hover:not(:disabled) {
             background-color: #2980b9;
         }

        .pagination button:hover:not(:disabled) {
            background-color: #ecf0f1;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
             background-color: #bdc3c7;
             color: #7f8c8d;
        }
        .pagination span {
            margin: 0 10px;
            font-weight: bold;
            color: #34495e;
        }
         .pagination label {
             font-weight: bold;
             color: #34495e;
         }
         .pagination select {
             padding: 8px 10px;
             border: 1px solid #bdc3c7;
             border-radius: 4px;
             font-size: 1em;
             cursor: pointer;
         }
        .pagination input[type="number"] {
            width: 50px; 
            text-align: center;
            padding: 8px 5px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 1em;
            -moz-appearance: textfield;
        }
        .pagination input[type="number"]::-webkit-outer-spin-button,
        .pagination input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .email-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }
        .email-table th {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #2980b9;
        }
        .email-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
             font-weight: normal;
             font-style: normal;
             color: inherit;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }

        .email-table th:nth-child(1), 
        .email-table td:nth-child(1) {
            width: 10%;
            white-space: nowrap;
        }

        .email-table th:nth-child(2), 
        .email-table td:nth-child(2) {
        }

        .email-table th:nth-child(3), 
        .email-table td:nth-child(3) {
            width: 20%;
        }

        .email-table th:nth-child(4), 
        .email-table td:nth-child(4) {
            width: 20%;
        }

        .email-table th:nth-child(5), 
        .email-table td:nth-child(5) {
            width: 8%;
            text-align: right;
        }

        .email-table th:nth-child(6), 
        .email-table td:nth-child(6) {
            width: 15%;
            text-align: center;
            white-space: nowrap;
        }

        .email-table td.subject-cell {
             display: table-cell;
        }
        .email-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .email-table tr.is-spam {
            background-color: #ffe0e0;
            color: #a00;
            border-left: 5px solid #e74c3c;
        }
        .email-table tbody tr.is-spam:nth-child(even),
        .email-table tbody tr.is-spam:nth-child(odd) {
            background-color: #ffe0e0;
            color: #a00;
        }

        .email-table td.actions-cell button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            font-weight: bold;

            background-color: #3498db;
            color: white;
            margin: 0 2px;
        }

         .email-table td.actions-cell button:hover {
             background-color: #2980b9;
         }

        @media (max-width: 768px) {
            .email-table {
                table-layout: auto;
            }

            .email-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .email-info {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .email-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-bar input[type="text"],
            .filter-bar input[type="date"],
            .filter-bar select,
            .filter-bar button {
                 max-width: 100%;
                 flex-basis: auto;
            }

            .email-table thead {
                display: none;
            }

            .email-table, .email-table tbody, .email-table tr, .email-table td {
                display: block;
                width: 100%;
            }

            .email-table tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }

            .email-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                 font-weight: normal;
                 font-style: normal;
                 color: inherit;
                 width: auto !important;
                 white-space: normal !important;
                 overflow: visible;
                 text-overflow: clip !important;
            }

            .email-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
                color: #555;
                text-align: left;
            }

             .email-table td.actions-cell {
                 text-align: right;
                 padding-left: 10px;
             }

             .email-table td.actions-cell::before {
                 content: '';
             }

             .email-table td.subject-cell,
             .email-table td.sender-cell,
             .email-table td.recipient-cell {
                 white-space: normal !important;
                 text-overflow: clip !important;
                 overflow: visible !important;
                 display: block;
             }

             .email-table td.size-cell {
                 text-align: right;
             }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fdecea;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 850px;
            width: fit-content;
            min-width: 350px;
            text-align: center;
            position: relative;
        }

        .modal-message {
            font-size: 1.1em;
            color: #721c24;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        /* Language Selector Styling */
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #ecf0f1;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .language-selector label {
            font-weight: bold;
            color: #34495e;
        }
        .language-selector select {
            padding: 8px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            background-color: white;
        }
        .language-selector button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .language-selector button:hover {
            background-color: #2980b9;
        }

        @media (max-width: 768px) {
            .language-selector {
                position: static; /* Remove absolute positioning on small screens */
                margin-bottom: 20px;
                width: calc(100% - 40px); /* Adjust width to fit padding */
                justify-content: center;
                flex-wrap: wrap;
                top: auto;
                right: auto;
            }
        }

        /* Loading Indicator Styles */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(244, 247, 246, 0.85); /* Page background color with opacity */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Ensure it's on top of other content */
            text-align: center;
        }
        .loading .spinner {
            border: 8px solid #bdc3c7; /* Lighter border color */
            border-top: 8px solid #3498db; /* Main theme color */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .loading p {
            color: #2c3e50; /* Dark text color, similar to h1 */
            font-size: 1.2em;
            font-weight: bold;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="language-selector">
        <label for="languageSelect" id="labelLanguageSelect"></label>
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="es">Español</option>
        </select>
        <button id="applyLanguageBtn"></button>
    </div>

    <h1 id="mainTitle"></h1>

    <div class="filter-bar">
        <label for="filterSubject" id="labelFilterSubject"></label>
        <input type="text" id="filterSubject">

        <label for="filterSender" id="labelFilterSender"></label>
        <input type="text" id="filterSender">

        <label for="filterRecipient" id="labelFilterRecipient"></label> <select id="filterRecipient">
            <option value="" id="filterRecipientAll"></option>
        </select>

        <label for="filterDate" id="labelFilterDate"></label>
        <input type="date" id="filterDate">

        <button id="applyFilterBtn"></button>
    </div>

    <div class="pagination">
        <button id="prevPageBtn"></button>
        <span id="paginationPageSpan"></span> <input type="number" id="currentPageInput" class="page-input" value="1" min="1"> <span id="totalPagesSpan"></span> <button id="nextPageBtn"></button>

         <label for="itemsPerPage" id="labelItemsPerPage"></label>
        <select id="itemsPerPage">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <table class="email-table">
        <thead>
            <tr>
                <th id="tableHeaderDateTime"></th>
                <th id="tableHeaderSubject"></th>
                <th id="tableHeaderSender"></th>
                <th id="tableHeaderRecipient"></th>
                <th id="tableHeaderSize"></th>
                <th id="tableHeaderActions"></th>
            </tr>
        </thead>
        <tbody id="email-list-body">
        </tbody>
    </table>

    <div class="pagination">
        <button id="prevPageBtn2"></button>
        <span id="paginationPageSpan2"></span> <input type="number" id="currentPageInput2" class="page-input" value="1" min="1"> <span id="totalPagesSpan2"></span>
        <button id="nextPageBtn2"></button>

         <label for="itemsPerPage2" id="labelItemsPerPage2"></label>
        <select id="itemsPerPage2">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingMessage"></p>
    </div>

    <div class="modal-overlay" id="spamModalOverlay">
        <div class="modal-content">
            <p class="modal-message" id="spamModalMessage"></p>
            <div class="modal-buttons">
                <button id="viewSpamButton" style="background-color: #e74c3c; color: white;"></button>
                <button id="cancelViewButton" style="background-color: #bdc3c7; color: #333;"></button>
            </div>
        </div>
    </div>

    <script>
        // Global variable for current language, fetched from server
        let currentLanguage = 'en'; // Default to English, will be updated on load

        // Translation object containing all UI and console messages
        const TRANSLATIONS = {
            "en": {
                "language_select_label": "Language:",
                "apply_language_btn": "Apply",
                "title": "Backed Up Email Explorer",
                "filter_subject_label": "Subject:",
                "filter_subject_placeholder": "Eg: Account Notice",
                "filter_sender_label": "Sender:",
                "filter_sender_placeholder": "Eg: Google or Gmail",
                "filter_recipient_label": "Mailbox:",
                "filter_recipient_all": "All",
                "filter_date_label": "Received Date:",
                "apply_filter_btn": "Apply Filter",
                "pagination_prev": "Previous",
                "pagination_next": "Next",
                "pagination_page": "Page",
                "pagination_of": "of",
                "pagination_emails_per_page": "Emails per page:",
                "loading_emails": "Loading Emails...",
                "processing_data": "Processing received data...",
                "error_loading_emails": "Error loading emails.",
                "no_emails_found_filters": "No emails found matching the filters.",
                "table_header_datetime": "Date & Time",
                "table_header_subject": "Subject",
                "table_header_sender": "Sender",
                "table_header_recipient": "Mailbox",
                "table_header_size": "Size",
                "table_header_actions": "Actions",
                "action_view": "View",
                "action_download": "Download",
                "modal_security_alert": "Security Alert.",
                "modal_spam_marked": "This Email is marked as SPAM.",
                "modal_spam_score": "Spam Score:",
                "modal_malicious_warning": "Opening it could expose your device to malicious software or reveal personal information.",
                "modal_download_malicious_warning": "Downloading it could expose your device to malicious software or reveal personal information.",
                "modal_continue_risk": "Do you wish to continue at your own risk?",
                "modal_view_anyway": "View Anyway",
                "modal_download_anyway": "Download Anyway",
                "modal_cancel": "Cancel",
                "error_invalid_file_path": "Error: Cannot open preview because the file path is invalid. Please check the email metadata.",
                "error_popup_blocked": "The email preview could not be opened. Your browser might have blocked the pop-up window. Please check your pop-up blocker settings.",
                "error_determine_email_action": "Error: Could not determine which email to view/download. Please try again.",
                "unknown_date": "Unknown date",
                "unknown_time": "Unknown time",
                "unknown_size": "Unknown size",
                "preview_simplified_message": "This is a simplified representation of the email. To view the full content with its original formatting, please download the file.",
                "preview_download_button": "Download Email",
                "preview_spam_warning": "Warning!<br>This email has been identified as SPAM.<br>Exercise caution when interacting with its content, as it could compromise your personal information.",
                "preview_date_time": "Date & Time:",
                "preview_from": "From:",
                "preview_to": "To:",
                "preview_cc": "CC:",
                "preview_subject": "Subject:",
                "preview_account": "Account:",
                "preview_no_content": "No viewable content found in this email.",
                "console_displaying_loading": "Displaying loading indicator: {message}",
                "console_hiding_loading": "Hiding loading indicator.",
                "console_updating_loading": "Updating loading message to: {message}",
                "console_fetching_metadata": "Attempting to fetch email metadata from /list-eml",
                "console_http_error_fetching": "HTTP error fetching emails: {status} - {statusText}",
                "console_loaded_emails_success": "Successfully loaded {count} emails.",
                "console_failed_load_emails": "Failed to load emails:",
                "console_populating_recipient_filter": "Populating recipient filter options.",
                "console_added_recipients": "Added {count} unique recipients to filter.",
                "console_applying_filters": "Applying filters to email list.",
                "console_filters_applied": "Filters applied. Found {count} matching emails.",
                "console_apply_filter_clicked": "Apply Filter button clicked.",
                "console_displaying_email_page": "Displaying email page...",
                "console_no_emails_for_display": "No emails found matching current filters for display.",
                "console_displaying_emails_from_index": "Displaying emails from index {startIndex} to {endIndex} on page {currentPage}.",
                "console_pagination_updated": "Pagination controls updated. Current page: {currentPage}, Total pages: {totalPages}.",
                "console_changing_page_by_direction": "Changing page by direction: {direction}",
                "console_invalid_page_navigation": "Attempted to navigate to invalid page: {newPage}. Current page remains {currentPage}.",
                "console_page_input_changed": "Page input changed.",
                "console_invalid_page_input": "Invalid page input: {value}. Setting to page 1.",
                "console_page_exceeds_total": "Page input {newPage} exceeds total pages {totalPages}. Setting to last page.",
                "console_navigating_to_page": "Navigating to page: {newPage}",
                "console_page_input_is_current": "Page input {newPage} is current page. No change.",
                "console_updating_emails_per_page": "Updating emails per page...",
                "console_changing_emails_per_page": "Changing emails per page to: {newItemsPerPage}",
                "console_attempting_view_email": "Attempting to view email: {encodedPath}, isSpam: {isSpam}",
                "console_displaying_spam_warning": "Displaying SPAM warning modal.",
                "console_hiding_spam_warning": "Hiding SPAM warning modal.",
                "console_error_invalid_file_path_preview": "Error: Cannot open preview because the file path is invalid.",
                "console_popup_blocked_preview": "The email preview could not be opened. Your browser might have blocked the pop-up window.",
                "console_opened_email_preview": "Opened email preview for: {encodedPath}",
                "console_spam_action_confirmed": "SPAM action confirmed.",
                "console_error_determine_action_after_spam": "Error: Could not determine which email to view/download after SPAM confirmation.",
                "console_attempting_download_email": "Attempting to download email: {encodedPath}, isSpam: {isSpam}",
                "console_initiating_download": "Initiating download for: {originalFilename} from {encodedPath}",
                "console_invalid_bytes_value": "Invalid bytes value for formatting: {bytes}",
                "console_invalid_input_escape_html": "Invalid input for escapeHTML: {str}. Returning empty string.",
                "console_window_loaded_initiating": "Window loaded. Initiating email loading process.",
                "console_spam_download_confirmed": "User confirmed SPAM download in preview. Initiating download.",
                "console_spam_download_cancelled": "User cancelled SPAM download in preview.",
                "console_fetching_settings": "Attempting to fetch language settings from /get-settings",
                "console_settings_fetch_success": "Successfully fetched language settings. Current language set to: {lang}",
                "console_settings_fetch_error": "Failed to fetch language settings. Defaulting to 'en'. Error: {error}",
                "console_saving_language_setting": "Saving language setting to server: {lang}",
                "console_language_saved_success": "Language setting saved successfully.",
                "console_language_save_failed": "Failed to save language setting: {error}"
            },
            "es": {
                "language_select_label": "Idioma:",
                "apply_language_btn": "Aplicar",
                "title": "Explorador de Correos Electrónicos Respaldados",
                "filter_subject_label": "Asunto:",
                "filter_subject_placeholder": "Ej: Aviso de Cuenta",
                "filter_sender_label": "Remitente:",
                "filter_sender_placeholder": "Ej: Google o Gmail",
                "filter_recipient_label": "Buzón:",
                "filter_recipient_all": "Todos",
                "filter_date_label": "Fecha de Recepción:",
                "apply_filter_btn": "Aplicar Filtro",
                "pagination_prev": "Anterior",
                "pagination_next": "Siguiente",
                "pagination_page": "Página",
                "pagination_of": "de",
                "pagination_emails_per_page": "Correos por página:",
                "loading_emails": "Cargando Correos...",
                "processing_data": "Procesando datos recibidos...",
                "error_loading_emails": "Error al cargar correos.",
                "no_emails_found_filters": "No se encontraron correos que coincidan con los filtros.",
                "table_header_datetime": "Fecha y Hora",
                "table_header_subject": "Asunto",
                "table_header_sender": "Remitente",
                "table_header_recipient": "Buzón",
                "table_header_size": "Tamaño",
                "table_header_actions": "Acciones",
                "action_view": "Ver",
                "action_download": "Descargar",
                "modal_security_alert": "Alerta de Seguridad.",
                "modal_spam_marked": "Este Correo Electrónico está marcado como SPAM.",
                "modal_spam_score": "Puntuación de Spam:",
                "modal_malicious_warning": "Abrirlo podría exponer su dispositivo a software malicioso o revelar información personal.",
                "modal_download_malicious_warning": "Descargarlo podría exponer su dispositivo a software malicioso o revelar información personal.",
                "modal_continue_risk": "¿Desea continuar bajo su propio riesgo?",
                "modal_view_anyway": "Ver de todos modos",
                "modal_download_anyway": "Descargar de todos modos",
                "modal_cancel": "Cancelar",
                "error_invalid_file_path": "Error: No se puede abrir la vista previa porque la ruta del archivo no es válida. Verifique los metadatos del correo electrónico.",
                "error_popup_blocked": "No se pudo abrir la vista previa del correo electrónico. Su navegador podría haber bloqueado la ventana emergente. Verifique la configuración de su bloqueador de ventanas emergentes.",
                "error_determine_email_action": "Error: No se pudo determinar qué correo electrónico ver/descargar. Inténtelo de nuevo.",
                "unknown_date": "Fecha desconocida",
                "unknown_time": "Hora desconocida",
                "unknown_size": "Tamaño desconocido",
                "preview_simplified_message": "Esta es una representación simplificada del Correo Electrónico. Para visualizar el contenido completo con su formato original, por favor descargue el archivo.",
                "preview_download_button": "Descargar Correo Electrónico",
                "preview_spam_warning": "¡Advertencia!<br>Este correo ha sido identificado como SPAM.<br>Se recomienda precaución al interactuar con su contenido, ya que podría comprometer su información personal.",
                "preview_date_time": "Fecha y Hora:",
                "preview_from": "De:",
                "preview_to": "Para:",
                "preview_cc": "CC:",
                "preview_subject": "Asunto:",
                "preview_account": "Cuenta:",
                "preview_no_content": "No se encontró contenido visualizable en este Correo Electrónico.",
                "console_displaying_loading": "Mostrando indicador de carga: {message}",
                "console_hiding_loading": "Ocultando indicador de carga.",
                "console_updating_loading": "Actualizando mensaje de carga a: {message}",
                "console_fetching_metadata": "Intentando obtener metadatos de correo electrónico de /list-eml",
                "console_http_error_fetching": "Error HTTP al obtener correos: {status} - {statusText}",
                "console_loaded_emails_success": "Se cargaron {count} correos electrónicos exitosamente.",
                "console_failed_load_emails": "Fallo al cargar correos:",
                "console_populating_recipient_filter": "Rellenando opciones de filtro de destinatarios.",
                "console_added_recipients": "Se agregaron {count} destinatarios únicos al filtro.",
                "console_applying_filters": "Aplicando filtros a la lista de correos.",
                "console_filters_applied": "Filtros aplicados. Se encontraron {count} correos electrónicos coincidentes.",
                "console_apply_filter_clicked": "Botón 'Aplicar Filtro' clickeado.",
                "console_displaying_email_page": "Mostrando página de correo electrónico...",
                "console_no_emails_for_display": "No se encontraron correos electrónicos que coincidan con los filtros actuales para mostrar.",
                "console_displaying_emails_from_index": "Mostrando correos electrónicos del índice {startIndex} al {endIndex} en la página {currentPage}.",
                "console_pagination_updated": "Controles de paginación actualizados. Página actual: {currentPage}, Páginas totales: {totalPages}.",
                "console_changing_page_by_direction": "Cambiando página por dirección: {direction}",
                "console_invalid_page_navigation": "Se intentó navegar a una página no válida: {newPage}. La página actual sigue siendo {currentPage}.",
                "console_page_input_changed": "Entrada de página cambiada.",
                "console_invalid_page_input": "Entrada de página no válida: {value}. Estableciendo a página 1.",
                "console_page_exceeds_total": "La entrada de página {newPage} excede el total de páginas {totalPages}. Estableciendo a la última página.",
                "console_navigating_to_page": "Navegando a la página: {newPage}",
                "console_page_input_is_current": "La entrada de página {newPage} es la página actual. Sin cambios.",
                "console_updating_emails_per_page": "Actualizando correos por página...",
                "console_changing_emails_per_page": "Cambiando correos por página a: {newItemsPerPage}",
                "console_attempting_view_email": "Intentando ver correo electrónico: {encodedPath}, esSpam: {isSpam}",
                "console_displaying_spam_warning": "Mostrando modal de advertencia de SPAM.",
                "console_hiding_spam_warning": "Ocultando modal de advertencia de SPAM.",
                "console_error_invalid_file_path_preview": "Error: No se puede abrir la vista previa porque la ruta del archivo no es válida.",
                "console_popup_blocked_preview": "No se pudo abrir la vista previa del correo electrónico. Su navegador podría haber bloqueado la ventana emergente.",
                "console_opened_email_preview": "Vista previa de correo electrónico abierta para: {encodedPath}",
                "console_spam_action_confirmed": "Acción de SPAM confirmada.",
                "console_error_determine_action_after_spam": "Error: No se pudo determinar qué correo electrónico ver/descargar después de la confirmación de SPAM.",
                "console_attempting_download_email": "Intentando descargar correo electrónico: {encodedPath}, esSpam: {isSpam}",
                "console_initiating_download": "Iniciando descarga para: {originalFilename} desde {encodedPath}",
                "console_invalid_bytes_value": "Valor de bytes no válido para formatear: {bytes}",
                "console_invalid_input_escape_html": "Entrada no válida para escapeHTML: {str}. Devolviendo cadena vacía.",
                "console_window_loaded_initiating": "Ventana cargada. Iniciando proceso de carga de correos electrónicos.",
                "console_spam_download_confirmed": "Usuario confirmó descarga de SPAM en vista previa. Iniciando descarga.",
                "console_spam_download_cancelled": "Usuario canceló descarga de SPAM en vista previa.",
                "console_fetching_settings": "Intentando obtener la configuración de idioma de /get-settings",
                "console_settings_fetch_success": "Configuración de idioma obtenida exitosamente. Idioma actual establecido en: {lang}",
                "console_settings_fetch_error": "Fallo al obtener la configuración de idioma. Predeterminado a 'en'. Error: {error}",
                "console_saving_language_setting": "Guardando configuración de idioma en el servidor: {lang}",
                "console_language_saved_success": "Configuración de idioma guardada exitosamente.",
                "console_language_save_failed": "Fallo al guardar la configuración de idioma: {error}"
            }
        };

        /**
         * Retrieves a translated string based on the current language.
         * @param {string} key - The key for the desired string in the TRANSLATIONS object.
         * @param {Object} [params={}] - Optional parameters to format the string.
         * @returns {string} The translated string, or a fallback message if not found.
         */
        function getTranslatedString(key, params = {}) {
            const langStrings = TRANSLATIONS[currentLanguage] || TRANSLATIONS["en"];
            let text = langStrings[key] || TRANSLATIONS["en"][key] || `MISSING_TRANSLATION_KEY_${key}`;

            // Replace placeholders like {count}
            for (const paramKey in params) {
                if (params.hasOwnProperty(paramKey)) {
                    text = text.replace(new RegExp(`\\{${paramKey}\\}`, 'g'), params[paramKey]);
                }
            }
            return text;
        }

        // Global variables to store email data and pagination state
        let allEmails = []; // Stores all email metadata loaded from the server
        let filteredEmails = []; // Stores emails after applying filters
        let currentPage = 1; // Current page number being displayed
        // Number of emails to display per page, initialized from the first selector
        let emailsPerPage = parseInt(document.querySelectorAll('.pagination #itemsPerPage')[0].value);

        // DOM element references for easier access
        const mainTitle = document.getElementById('mainTitle');
        const labelFilterSubject = document.getElementById('labelFilterSubject');
        const filterSubjectInput = document.getElementById('filterSubject'); 
        const labelFilterSender = document.getElementById('labelFilterSender');
        const senderInput = document.getElementById('filterSender'); 
        const labelFilterRecipient = document.getElementById('labelFilterRecipient');
        const recipientFilterSelect = document.getElementById('filterRecipient'); 
        const filterRecipientAll = document.getElementById('filterRecipientAll');
        const labelFilterDate = document.getElementById('labelFilterDate');
        const dateInput = document.getElementById('filterDate'); 
        const applyFilterButton = document.getElementById('applyFilterBtn'); 

        const prevPageBtns = [document.getElementById('prevPageBtn'), document.getElementById('prevPageBtn2')];
        const nextPageBtns = [document.getElementById('nextPageBtn'), document.getElementById('nextPageBtn2')];
        const currentPageInputs = [document.getElementById('currentPageInput'), document.getElementById('currentPageInput2')]; 
        const totalPagesSpans = [document.getElementById('totalPagesSpan'), document.getElementById('totalPagesSpan2')]; 
        const itemsPerPageSelects = [document.getElementById('itemsPerPage'), document.getElementById('itemsPerPage2')];
        const paginationPageSpans = [document.getElementById('paginationPageSpan'), document.getElementById('paginationPageSpan2')];
        const labelItemsPerPageSpans = [document.getElementById('labelItemsPerPage'), document.getElementById('labelItemsPerPage2')];

        const emailListBody = document.getElementById('email-list-body');
        const loadingElement = document.getElementById('loading');
        const loadingMessageElement = document.getElementById('loadingMessage');

        const tableHeaderDateTime = document.getElementById('tableHeaderDateTime');
        const tableHeaderSubject = document.getElementById('tableHeaderSubject');
        const tableHeaderSender = document.getElementById('tableHeaderSender');
        const tableHeaderRecipient = document.getElementById('tableHeaderRecipient');
        const tableHeaderSize = document.getElementById('tableHeaderSize');
        const tableHeaderActions = document.getElementById('tableHeaderActions');

        // SPAM Warning Modal elements
        const spamModalOverlay = document.getElementById('spamModalOverlay'); 
        const spamModalMessage = document.getElementById('spamModalMessage'); 
        const viewSpamButton = document.getElementById('viewSpamButton'); 
        const cancelViewButton = document.getElementById('cancelViewButton'); 

        // Language selector elements
        const languageSelect = document.getElementById('languageSelect');
        const labelLanguageSelect = document.getElementById('labelLanguageSelect');
        const applyLanguageBtn = document.getElementById('applyLanguageBtn');

        // Variables to manage the pending action from the SPAM modal
        let currentSpamActionType = null; // Stores the SPAM action type: 'view' or 'download'
        let currentSpamActionArgs = null; // Stores arguments for the SPAM action (e.g., path, filename)

        /**
         * Updates all static text content in the HTML based on the current language.
         */
        function updateUIStrings() {
            document.documentElement.lang = currentLanguage;
            
            // Language selector
            labelLanguageSelect.textContent = getTranslatedString('language_select_label');
            applyLanguageBtn.textContent = getTranslatedString('apply_language_btn');
            languageSelect.value = currentLanguage; // Set the dropdown to the current language

            mainTitle.textContent = getTranslatedString('title');
            labelFilterSubject.textContent = getTranslatedString('filter_subject_label');
            filterSubjectInput.placeholder = getTranslatedString('filter_subject_placeholder');
            labelFilterSender.textContent = getTranslatedString('filter_sender_label');
            senderInput.placeholder = getTranslatedString('filter_sender_placeholder');
            labelFilterRecipient.textContent = getTranslatedString('filter_recipient_label');
            filterRecipientAll.textContent = getTranslatedString('filter_recipient_all');
            labelFilterDate.textContent = getTranslatedString('filter_date_label');
            applyFilterButton.textContent = getTranslatedString('apply_filter_btn');

            prevPageBtns.forEach(btn => btn.textContent = getTranslatedString('pagination_prev'));
            nextPageBtns.forEach(btn => btn.textContent = getTranslatedString('pagination_next'));
            paginationPageSpans.forEach(span => span.textContent = getTranslatedString('pagination_page'));
            labelItemsPerPageSpans.forEach(span => span.textContent = getTranslatedString('pagination_emails_per_page'));

            tableHeaderDateTime.textContent = getTranslatedString('table_header_datetime');
            tableHeaderSubject.textContent = getTranslatedString('table_header_subject');
            tableHeaderSender.textContent = getTranslatedString('table_header_sender');
            tableHeaderRecipient.textContent = getTranslatedString('table_header_recipient');
            tableHeaderSize.textContent = getTranslatedString('table_header_size');
            tableHeaderActions.textContent = getTranslatedString('table_header_actions');

            viewSpamButton.textContent = getTranslatedString('modal_view_anyway');
            cancelViewButton.textContent = getTranslatedString('modal_cancel');
        }

        // Event Listeners for pagination and filter controls
        prevPageBtns.forEach(btn => {
            btn.addEventListener('click', () => changePage(-1));
        });
        nextPageBtns.forEach(btn => {
            btn.addEventListener('click', () => changePage(1));
        });

        itemsPerPageSelects.forEach(select => {
            select.addEventListener('change', changeItemsPerPage);
        });

        currentPageInputs.forEach(input => {
            input.addEventListener('change', goToPageFromInput);
        });

        if (applyFilterButton) {
            applyFilterButton.addEventListener('click', handleApplyFilters);
        }

        // Event Listeners for SPAM modal buttons
        if (viewSpamButton) {
            viewSpamButton.addEventListener('click', handleSpamActionConfirm);
        }
        if (cancelViewButton) {
            cancelViewButton.addEventListener('click', hideSpamWarningModal);
        }

        // Event listener for language selection
        if (applyLanguageBtn) {
            applyLanguageBtn.addEventListener('click', async () => {
                const selectedLang = languageSelect.value;
                if (selectedLang !== currentLanguage) {
                    await saveLanguageSetting(selectedLang);
                    currentLanguage = selectedLang; // Update global language after successful save
                    updateUIStrings(); // Re-render UI with new language
                    displayCurrentPageEmails(); // Re-render email table with new button texts
                }
            });
        }

        /**
         * Displays the loading indicator at the bottom right of the screen.
         * @param {string} message - The message to display in the loading indicator.
         */
        function showLoading(message = getTranslatedString('loading_emails')) {
            console.log(getTranslatedString('console_displaying_loading', { message: message }));
            loadingMessageElement.textContent = message;
            loadingElement.style.display = 'flex';
        }

        /**
         * Hides the loading indicator.
         */
        function hideLoading() {
            console.log(getTranslatedString('console_hiding_loading'));
            loadingElement.style.display = 'none';
        }

        /**
         * Updates the message text within the loading indicator.
         * @param {string} message - The new message to display.
         */
        function updateLoadingMessage(message) {
            console.log(getTranslatedString('console_updating_loading', { message: message }));
            loadingMessageElement.textContent = message;
        }

        /**
         * Asynchronously loads all email metadata from the server.
         * This is the main function executed when the page loads.
         */
        async function loadAllEmailsForFiltering() {
            showLoading(getTranslatedString('loading_emails'));
            console.log(getTranslatedString('console_fetching_metadata'));
            try {
                const response = await fetch('/list-eml');
                if (!response.ok) {
                    console.error(getTranslatedString('console_http_error_fetching', { status: response.status, statusText: response.statusText }));
                    throw new Error(`HTTP error: ${response.status} - ${response.statusText}`);
                }
                updateLoadingMessage(getTranslatedString('processing_data'));
                const data = await response.json();
                allEmails = data.emails || [];
                console.log(getTranslatedString('console_loaded_emails_success', { count: allEmails.length }));

                populateRecipientFilter(allEmails);
                handleApplyFilters();

            } catch (error) {
                console.error(getTranslatedString('console_failed_load_emails'), error);
                emailListBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${getTranslatedString('error_loading_emails')}</td></tr>`;
                allEmails = [];
                filteredEmails = [];
                updatePaginationControls();
                updateLoadingMessage(getTranslatedString('error_loading_emails'));
                hideLoading();
            }
        }

        /**
         * Populates the recipient (POP3 mailbox) filter select with unique options based on loaded emails.
         * This allows users to filter emails by the POP3 mailbox they arrived in.
         * @param {Array<Object>} emails - The list of loaded email objects.
         */
        function populateRecipientFilter(emails) {
            console.log(getTranslatedString('console_populating_recipient_filter'));
            const recipients = [...new Set(emails.map(email => email.recipient).filter(Boolean))];
            recipients.sort(); 

            recipientFilterSelect.innerHTML = `<option value="">${getTranslatedString('filter_recipient_all')}</option>`;

            recipients.forEach(recipient => {
                const option = document.createElement('option');
                option.value = recipient;
                option.textContent = recipient;
                recipientFilterSelect.appendChild(option);
            });
            console.log(getTranslatedString('console_added_recipients', { count: recipients.length }));
        }

        /**
         * Applies search filters (subject, sender, recipient, date) to all loaded emails.
         * Updates the 'filteredEmails' list with the results and resets pagination to the first page.
         */
        function applyFilters() {
             showLoading(getTranslatedString('apply_filter_btn'));
            console.log(getTranslatedString('console_applying_filters'));
            const subjectTerm = filterSubjectInput.value.toLowerCase();
            const senderTerm = senderInput.value.toLowerCase();
            const selectedRecipient = recipientFilterSelect.value; 
            const selectedDate = dateInput.value; 

            filteredEmails = allEmails.filter(email => {
                const matchesSubject = subjectTerm === '' || (email.subject && email.subject.toLowerCase().includes(subjectTerm));
                const matchesSender = senderTerm === '' || (email.sender && email.sender.toLowerCase().includes(senderTerm));
                const matchesRecipient = selectedRecipient === '' || (email.recipient && email.recipient === selectedRecipient);
                const matchesDate = selectedDate === '' || (email.date && email.date.split('-').reverse().join('-') === selectedDate);

                return matchesSubject && matchesSender && matchesRecipient && matchesDate;
            });

             filteredEmails.sort((a, b) => {
                 const dateA = (a.date && a.time) ? `${a.date.split('-')[2]}${a.date.split('-')[1]}${a.date.split('-')[0]}${a.time.replace('-', '')}` : '0';
                 const dateB = (b.date && b.time) ? `${b.date.split('-')[2]}${b.date.split('-')[1]}${b.date.split('-')[0]}${b.time.replace('-', '')}` : '0';

                 if (dateA < dateB) return 1;
                 if (dateA > dateB) return -1;
                 return 0;
             });

            currentPage = 1; 
            console.log(getTranslatedString('console_filters_applied', { count: filteredEmails.length }));
            displayCurrentPageEmails(); 
            window.scrollTo(0, 0); 
            hideLoading();
        }

        /**
         * Handles the "Apply Filter" button click event.
         * This function initiates the filtering and table update process.
         */
         function handleApplyFilters() {
             console.log(getTranslatedString('console_apply_filter_clicked'));
             applyFilters();
         }

        /**
         * Displays the emails for the current page in the HTML table.
         * Calculates which emails to show based on 'currentPage' and 'emailsPerPage'.
         */
        function displayCurrentPageEmails() {
             showLoading(getTranslatedString('console_displaying_email_page'));
            const startIndex = (currentPage - 1) * emailsPerPage;
            const endIndex = startIndex + emailsPerPage;
            const emailsToDisplay = filteredEmails.slice(startIndex, endIndex);

            emailListBody.innerHTML = '';

            if (emailsToDisplay.length === 0) {
                console.log(getTranslatedString('console_no_emails_for_display'));
                const noResultsRow = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6; 
                cell.textContent = getTranslatedString('no_emails_found_filters');
                cell.style.textAlign = 'center';
                noResultsRow.appendChild(cell);
                emailListBody.appendChild(noResultsRow);
            } else {
                console.log(getTranslatedString('console_displaying_emails_from_index', { startIndex: startIndex, endIndex: endIndex - 1, currentPage: currentPage }));
                emailsToDisplay.forEach(email => {
                    const row = document.createElement('tr');
                    const determinedIsSpam = email.is_spam === true; 
                    const spamScoreForModal = email.spam_score;
                    const spamFilterWhitelistStatus = email.spam_filter_whitelist ? email.spam_filter_whitelist.toLowerCase() : 'no';

                    if (determinedIsSpam) {
                        row.classList.add('is-spam');
                    }
                    const encodedPath = encodeURIComponent(email.path); 

                    row.innerHTML = `
                        <td data-label="${getTranslatedString('table_header_datetime')}:" class="datetime-cell">${formatDate(email.date)} ${formatTime(email.time)}</td>
                        <td data-label="${getTranslatedString('table_header_subject')}:" class="subject-cell" title="${escapeHTML(email.subject)}">${escapeHTML(email.subject)}</td>
                        <td data-label="${getTranslatedString('table_header_sender')}:" class="sender-cell" title="${escapeHTML(email.sender)}">${escapeHTML(email.sender)}</td>
                        <td data-label="${getTranslatedString('table_header_recipient')}:" class="recipient-cell" title="${escapeHTML(email.recipient)}">${escapeHTML(email.recipient)}</td>
                        <td data-label="${getTranslatedString('table_header_size')}:" class="size-cell">${formatBytes(email.tamano_eml)}</td>
                        <td data-label="${getTranslatedString('table_header_actions')}:" class="actions-cell">
                            <button class="view-button" onclick="viewEmail('${encodedPath}', ${determinedIsSpam}, ${spamScoreForModal === null || spamScoreForModal === undefined ? 'null' : spamScoreForModal}, '${spamFilterWhitelistStatus}')">${getTranslatedString('action_view')}</button>
                            <button class="download-button" onclick="downloadEmail('${encodedPath}', '${escapeHTML(email.name)}', ${determinedIsSpam}, ${spamScoreForModal === null || spamScoreForModal === undefined ? 'null' : spamScoreForModal}, '${spamFilterWhitelistStatus}')">${getTranslatedString('action_download')}</button>
                        </td>
                    `;
                    emailListBody.appendChild(row);
                });
            }

            updatePaginationControls(); 
            hideLoading();
        }

        /**
         * Updates the page information text and enables/disables pagination buttons.
         * This reflects the current page and the total number of available pages.
         */
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredEmails.length / emailsPerPage);
            
            currentPageInputs.forEach(input => {
                input.value = currentPage;
                input.max = totalPages > 0 ? totalPages : 1; 
            });
            totalPagesSpans.forEach(span => {
                span.textContent = `${getTranslatedString('pagination_of')} ${totalPages || 1}`;
            });

            prevPageBtns.forEach(btn => {
                btn.disabled = currentPage === 1 || filteredEmails.length === 0;
            });
            nextPageBtns.forEach(btn => {
                btn.disabled = currentPage >= totalPages || filteredEmails.length === 0;
            });
            console.log(getTranslatedString('console_pagination_updated', { currentPage: currentPage, totalPages: totalPages }));
        }

        /**
         * Changes the current page displayed in the table.
         * Called when "Previous" or "Next" buttons are clicked.
         * @param {number} direction - The direction of change (-1 for previous, 1 for next).
         */
        function changePage(direction) {
            console.log(getTranslatedString('console_changing_page_by_direction', { direction: direction }));
            const totalPages = Math.ceil(filteredEmails.length / emailsPerPage);
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCurrentPageEmails();
                window.scrollTo(0, 0); 
            } else {
                console.warn(getTranslatedString('console_invalid_page_navigation', { newPage: newPage, currentPage: currentPage }));
            }
        }

        /**
         * Handles direct page number input by the user.
         * Validates the input and navigates to the page if valid.
         */
        function goToPageFromInput(event) {
            console.log(getTranslatedString('console_page_input_changed'));
            let newPage = parseInt(event.target.value); 
            const totalPages = Math.ceil(filteredEmails.length / emailsPerPage);

            if (isNaN(newPage) || newPage < 1) {
                console.warn(getTranslatedString('console_invalid_page_input', { value: event.target.value }));
                newPage = 1;
            }
            if (newPage > totalPages && totalPages > 0) {
                console.warn(getTranslatedString('console_page_exceeds_total', { newPage: newPage, totalPages: totalPages }));
                newPage = totalPages;
            }
            if (filteredEmails.length === 0) {
                newPage = 1;
            }

            if (newPage !== currentPage) {
                console.log(getTranslatedString('console_navigating_to_page', { newPage: newPage }));
                currentPage = newPage;
                displayCurrentPageEmails();
                window.scrollTo(0, 0);
            } else {
                console.log(getTranslatedString('console_page_input_is_current', { newPage: newPage }));
                currentPageInputs.forEach(input => {
                    input.value = currentPage;
                });
            }
        }

        /**
         * Handles the change in the number of items to display per page selected by the user.
         * Called when the user selects a new value in the "Emails per page" selector.
         * @param {Event} event - The change event triggered by the selector.
         */
        function changeItemsPerPage(event) {
            showLoading(getTranslatedString('console_updating_emails_per_page'));
            const newItemsPerPage = parseInt(event.target.value);
            console.log(getTranslatedString('console_changing_emails_per_page', { newItemsPerPage: newItemsPerPage }));
            emailsPerPage = newItemsPerPage;

            itemsPerPageSelects.forEach(select => {
                select.value = newItemsPerPage;
            });

            currentPage = 1; 
            displayCurrentPageEmails();
            window.scrollTo(0, 0);
            hideLoading();
        }

        /**
         * Initiates the process to open the content of an .eml file in a new tab.
         * If the email is marked as spam, it shows a warning modal before proceeding.
         * @param {string} encodedPath - The relative path of the .eml file to view, already URI encoded.
         * @param {boolean} isSpam - Indicates if the email is marked as spam.
         * @param {number|null} spamScore - The spam score of the email, or null if not available.
         * @param {string} spamFilterWhitelistStatus - Spam whitelist status ('yes' or 'no').
         */
        function viewEmail(encodedPath, isSpam, spamScore, spamFilterWhitelistStatus) {
            console.log(getTranslatedString('console_attempting_view_email', { encodedPath: encodedPath, isSpam: isSpam }));
            if (isSpam) {
                currentSpamActionType = 'view';
                currentSpamActionArgs = { path: encodedPath };
                showSpamWarningModal(`${getTranslatedString('modal_security_alert')}<br>${getTranslatedString('modal_spam_marked')}<br>` + 
                                     (spamScore !== null && spamScore !== undefined ? `${getTranslatedString('modal_spam_score')} ${spamScore}<br>` : '') +
                                     `${getTranslatedString('modal_malicious_warning')}<br>${getTranslatedString('modal_continue_risk')}`);
            } else {
                openEmailPreview(encodedPath);
            }
        }

        /**
         * Displays the SPAM warning modal with the provided message.
         * Sets the confirmation button text based on the pending action ('view' or 'download').
         * @param {string} message - The HTML message to display within the modal.
         */
        function showSpamWarningModal(message) {
            console.warn(getTranslatedString('console_displaying_spam_warning'));
            spamModalMessage.innerHTML = message;
            if (currentSpamActionType === 'download') {
                viewSpamButton.textContent = getTranslatedString('modal_download_anyway');
            } else {
                viewSpamButton.textContent = getTranslatedString('modal_view_anyway');
            }
            spamModalOverlay.style.display = 'flex';
        }

        /**
         * Hides the SPAM warning modal and resets pending action variables.
         */
        function hideSpamWarningModal() {
            console.log(getTranslatedString('console_hiding_spam_warning'));
            spamModalOverlay.style.display = 'none';
            currentSpamActionType = null;
            currentSpamActionArgs = null;
        }

        /**
         * Opens a new browser tab to display the HTML preview of an .eml file.
         * Called after confirming the action (if the email was spam) or directly if not spam.
         * @param {string} encodedPath - The relative path of the .eml file to view, already URI encoded.
         */
        function openEmailPreview(encodedPath) {
            if (!encodedPath || typeof encodedPath !== 'string' || encodedPath.trim() === "" || encodedPath === "undefined" || encodedPath === "null") {
                console.error(getTranslatedString('console_error_invalid_file_path_preview'));
                return;
            }

            const viewUrl = `/view-html-eml?path=${encodedPath}`;
            const newWindow = window.open(viewUrl, '_blank');

            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                console.warn(getTranslatedString('console_popup_blocked_preview'));
            } else {
                console.log(getTranslatedString('console_opened_email_preview', { encodedPath: encodedPath }));
            }
        }

        /**
         * Handles the click on the confirmation button ("View Anyway" or "Download Anyway") of the SPAM modal.
         * Executes the pending action (view or download) if the user confirms.
         */
        function handleSpamActionConfirm() {
            console.log(getTranslatedString('console_spam_action_confirmed'));
            if (currentSpamActionType === 'view' && currentSpamActionArgs && currentSpamActionArgs.path) {
                openEmailPreview(currentSpamActionArgs.path);
            } else if (currentSpamActionType === 'download' && currentSpamActionArgs && currentSpamActionArgs.path && currentSpamActionArgs.filename) {
                performActualDownload(currentSpamActionArgs.path, currentSpamActionArgs.filename);
            } else {
                console.error(getTranslatedString('console_error_determine_action_after_spam'));
            }
            hideSpamWarningModal();
        }

        /**
         * Initiates the process to download a specific .eml file from the server.
         * If the email is spam, it shows a warning modal before proceeding with the download.
         * @param {string} encodedPath - The relative path of the .eml file to download, already URI encoded.
         * @param {string} originalFilename - The original filename for the download.
         * @param {boolean} isSpam - Indicates if the email is marked as spam.
         * @param {number|null} spamScore - The spam score of the email, or null if not available.
         * @param {string} spamFilterWhitelistStatus - Spam whitelist status ('yes' or 'no').
         */
        function downloadEmail(encodedPath, originalFilename, isSpam, spamScore, spamFilterWhitelistStatus) {
            console.log(getTranslatedString('console_attempting_download_email', { encodedPath: encodedPath, isSpam: isSpam }));
            if (isSpam) {
                currentSpamActionType = 'download';
                currentSpamActionArgs = { path: encodedPath, filename: originalFilename };
                showSpamWarningModal(`${getTranslatedString('modal_security_alert')}<br>${getTranslatedString('modal_spam_marked')}<br>` + 
                                     (spamScore !== null && spamScore !== undefined ? `${getTranslatedString('modal_spam_score')} ${spamScore}<br>` : '') +
                                     `${getTranslatedString('modal_download_malicious_warning')}<br>${getTranslatedString('modal_continue_risk')}`);
            } else {
                performActualDownload(encodedPath, originalFilename);
            }
        }

        /**
         * Performs the actual download of the .eml file by creating a temporary link and simulating a click.
         * Called after confirming the action (if the email was spam) or directly if not spam.
         * @param {string} encodedPath - The relative path of the .eml file to download, already URI encoded.
         * @param {string} originalFilename - The original filename for the download.
         */
        function performActualDownload(encodedPath, originalFilename) {
            console.log(getTranslatedString('console_initiating_download', { originalFilename: originalFilename, encodedPath: encodedPath }));
            const link = document.createElement('a');
            link.href = `/download-eml?path=${encodedPath}`;
            link.download = originalFilename;
            document.body.appendChild(link); // Append to body to ensure it's clickable in all browsers
            link.click();
            document.body.removeChild(link); // Clean up the temporary link
        }

        /**
         * Formats a date string from "DD-MM-YYYY" to "DD/MM/YYYY".
         * @param {string} dateStr - The date string in "DD-MM-YYYY" format.
         * @returns {string} The formatted date or 'Unknown date' if input is null or empty.
         */
        function formatDate(dateStr) {
            if (!dateStr) {
                return getTranslatedString('unknown_date');
            }
            return dateStr.replace(/-/g, '/');
        }

        /**
         * Formats a time string from "HH-mm" to "HH:mm".
         * @param {string} timeStr - The time string in "HH-mm" format.
         * @returns {string} The formatted time or 'Unknown time' if input is null or empty.
         */
        function formatTime(timeStr) {
             if (!timeStr) {
                 return getTranslatedString('unknown_time');
             }
            return timeStr.replace('-', ':');
        }

        /**
         * Formats a size in bytes to a human-readable format (Bytes, KB, MB, etc.).
         * @param {number} bytes - The size in bytes.
         * @param {number} decimals - The number of decimal places to show. Defaults to 2.
         * @returns {string} The formatted size with its unit or 'Unknown size' if input is null, undefined, or 0.
         */
        function formatBytes(bytes, decimals = 2) {
            if (bytes === undefined || bytes === null || typeof bytes !== 'number' || bytes < 0) {
                 console.warn(getTranslatedString('console_invalid_bytes_value', { bytes: bytes }));
                 return getTranslatedString('unknown_size');
            }
             if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        /**
         * Escapes special HTML characters in a text string to prevent Cross-Site Scripting (XSS) attacks.
         * This is crucial when displaying server-generated or user-generated content directly in HTML.
         * @param {string} str - The text string to escape.
         * @returns {string} The string with HTML characters escaped, or an empty string if input is null or empty.
         */
        function escapeHTML(str) {
            if (!str || typeof str !== 'string') {
                 console.warn(getTranslatedString('console_invalid_input_escape_html', { str: str }));
                 return '';
            }
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        /**
         * Fetches the language setting from the server and updates the UI.
         */
        async function fetchLanguageSettings() {
            console.log(getTranslatedString('console_fetching_settings'));
            try {
                const response = await fetch('/get-settings');
                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status}`);
                }
                const settings = await response.json();
                if (settings && settings.lang) {
                    currentLanguage = settings.lang;
                    console.log(getTranslatedString('console_settings_fetch_success', { lang: currentLanguage }));
                } else {
                    console.warn(getTranslatedString('console_settings_fetch_error', { error: 'Invalid response structure' }));
                }
            } catch (error) {
                console.error(getTranslatedString('console_settings_fetch_error', { error: error.message }));
            } finally {
                updateUIStrings(); // Update UI strings after fetching language (or defaulting)
            }
        }

        /**
         * Sends the selected language setting to the server to be saved.
         * @param {string} lang - The language code to save ('en' or 'es').
         */
        async function saveLanguageSetting(lang) {
            console.log(getTranslatedString('console_saving_language_setting', { lang: lang }));
            try {
                const response = await fetch('/set-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lang: lang })
                });
                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status}`);
                }
                console.log(getTranslatedString('console_language_saved_success'));
                return true;
            } catch (error) {
                console.error(getTranslatedString('console_language_save_failed', { error: error.message }));
                return false;
            }
        }

        // Initiates loading of email metadata when the HTML page has fully loaded.
        window.onload = async () => {
            console.log(getTranslatedString('console_window_loaded_initiating'));
            await fetchLanguageSettings(); // Fetch language settings first
            loadAllEmailsForFiltering();
        };
    </script>
</body>
</html>
