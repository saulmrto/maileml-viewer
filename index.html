<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Correos Electrónicos Respaldados</title>
    <style>
        /* Estilos generales para el cuerpo de la página */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            position: relative;
            line-height: 1.6;
            color: #333;
        }

        /* Estilos para el título principal de la página */
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        /* Estilos para el área de filtros (barra superior) */
        .filter-bar {
            margin-bottom: 20px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        /* Estilos para las etiquetas dentro de la barra de filtros */
        .filter-bar label {
            font-weight: bold;
            color: #34495e;
            display: inline-block;
        }
        /* Estilos para los campos de entrada de texto, fecha, select y botón dentro de la barra de filtros */
        .filter-bar input[type="text"],
        .filter-bar input[type="date"],
        .filter-bar select,
        .filter-bar button {
            padding: 10px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            flex-basis: 150px;
            flex-grow: 1;
            min-width: 100px;
        }
         /* Ajuste específico para el botón para que no crezca tanto como los inputs */
         .filter-bar button {
             flex-grow: 0;
             flex-shrink: 0;
             flex-basis: auto;
             min-width: auto;
             background-color: #3498db;
             color: white;
             cursor: pointer;
             transition: background-color 0.3s ease;
             font-weight: bold;
         }

         /* Estilo específico para el selector (dropdown) */
         .filter-bar select {
             cursor: pointer;
         }
        /* Estilo para el botón de filtro al pasar el el ratón por encima */
        .filter-bar button:hover {
            background-color: #2980b9;
        }


        /* Estilos para el contenedor de paginación */
        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
         /* Estilos para los botones dentro de la sección de paginación */
         .pagination button {
            padding: 10px 15px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background-color: #ffffff;
            color: #34495e;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
             font-weight: bold;
        }
        /* Estilos específicos para los botones "Anterior" y "Siguiente" */
        .pagination button#prevPageBtn,
        .pagination button#nextPageBtn {
            background-color: #3498db;
            color: white;
        }
         /* Estilos para los botones "Anterior" y "Siguiente" al pasar el ratón (si no están deshabilitados) */
         .pagination button#prevPageBtn:hover:not(:disabled),
         .pagination button#nextPageBtn:hover:not(:disabled) {
             background-color: #2980b9;
         }

        /* Estilos para los botones de paginación al pasar el ratón (si no están deshabilitados) */
        .pagination button:hover:not(:disabled) {
            background-color: #ecf0f1;
        }
        /* Estilos para los botones de paginación cuando están deshabilitados */
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
             background-color: #bdc3c7;
             color: #7f8c8d;
        }
        /* Estilos para el texto de información de la página (ej. "Página 1 de 1") */
        .pagination span {
            margin: 0 10px;
            font-weight: bold;
            color: #34495e;
        }
         /* Estilos para las etiquetas dentro de la sección de paginación */
         .pagination label {
             font-weight: bold;
             color: #34495e;
         }
         /* Estilos para el selector de elementos por página */
         .pagination select {
             padding: 8px 10px;
             border: 1px solid #bdc3c7;
             border-radius: 4px;
             font-size: 1em;
             cursor: pointer;
         }

        /* Estilos para el input de número de página */
        .pagination input[type="number"] {
            width: 50px; /* Ancho fijo para el input de página */
            text-align: center;
            padding: 8px 5px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 1em;
            -moz-appearance: textfield; /* Oculta las flechas en Firefox */
        }
        /* Oculta las flechas en Chrome, Safari, Edge */
        .pagination input[type="number"]::-webkit-outer-spin-button,
        .pagination input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        /* Estilos para el mensaje de carga */
        .loading {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 18px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
             border: 1px solid #bdc3c7;
        }
         .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        /* Definición de la animación de giro (keyframes) */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Estilos para la tabla de correos */
        .email-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        /* Estilos para las celdas de encabezado de la tabla */
        .email-table th {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #2980b9;
        }

         /* Estilos para las celdas de datos de la tabla */
        .email-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
             font-weight: normal;
             font-style: normal;
             color: inherit;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }

        /* Definir anchos fijos para las columnas (ajustados para 6 columnas) */
        .email-table th:nth-child(1), /* Columna 1: Fecha y Hora */
        .email-table td:nth-child(1) {
            width: 10%;
            white-space: nowrap;
        }

        .email-table th:nth-child(2), /* Columna 2: Asunto */
        .email-table td:nth-child(2) {
             /* El ancho del Asunto se ajustará automáticamente para llenar el espacio restante */
        }

        .email-table th:nth-child(3), /* Columna 3: Remitente */
        .email-table td:nth-child(3) {
            width: 20%;
        }

        .email-table th:nth-child(4), /* Columna 4: Destinatario (ahora Buzón POP3) */
        .email-table td:nth-child(4) {
            width: 20%;
        }

        .email-table th:nth-child(5), /* Columna 5: Tamaño */
        .email-table td:nth-child(5) {
            width: 8%;
            text-align: right;
        }

        .email-table th:nth-child(6), /* Columna 6: Acciones */
        .email-table td:nth-child(6) {
            width: 15%;
            text-align: center;
            white-space: nowrap;
        }


        /* Estilos para la celda del asunto en la tabla (se simplifica para una sola línea) */
        .email-table td.subject-cell {
             display: table-cell;
             -webkit-line-clamp: unset;
             -webkit-box-orient: unset;
             line-clamp: unset;
             box-orient: unset;
        }

        /* Estilos para las celdas de remitente y destinatario (aplicar recorte de una línea) */
        .email-table td.sender-cell,
        .email-table td.recipient-cell {
        }


        /* Estilos para las filas pares de la tabla */
        .email-table tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* NUEVO: Estilo para filas de correos marcados como SPAM */
        .email-table tr.is-spam {
            background-color: #ffe0e0; /* Rojo suave para el fondo */
            color: #a00; /* Texto más oscuro para contraste */
            border-left: 5px solid #e74c3c; /* Borde rojo más fuerte a la izquierda */
        }
        /* Asegurar que el estilo de spam prevalezca sobre el de filas pares/impares */
        .email-table tbody tr.is-spam:nth-child(even),
        .email-table tbody tr.is-spam:nth-child(odd) {
            background-color: #ffe0e0; /* Sobrescribe el color de fondo de filas pares/impares */
            color: #a00;
        }


        /* Estilos para los botones de acción dentro de la tabla */
        .email-table td.actions-cell button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            font-weight: bold;

            background-color: #3498db;
            color: white;
            margin: 0 2px;
        }

        /* Estilos para los botones de acción al pasar el ratón por encima */
         .email-table td.actions-cell button:hover {
             background-color: #2980b9;
         }


        /* Hacer la tabla responsiva */
        @media (max-width: 768px) {
            .email-table {
                table-layout: auto;
            }

            .email-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .email-info {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .email-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-bar input[type="text"],
            .filter-bar input[type="date"],
            .filter-bar select,
            .filter-bar button {
                 max-width: 100%;
                 flex-basis: auto;
            }

            .email-table thead {
                display: none;
            }

            .email-table, .email-table tbody, .email-table tr, .email-table td {
                display: block;
                width: 100%;
            }

            .email-table tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }

            .email-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                 font-weight: normal;
                 font-style: normal;
                 color: inherit;
                 width: auto !important;
                 white-space: normal !important;
                 overflow: visible;
                 text-overflow: clip !important;
            }

            .email-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
                color: #555;
                text-align: left;
            }

             .email-table td.actions-cell {
                 text-align: right;
                 padding-left: 10px;
             }

             .email-table td.actions-cell::before {
                 content: '';
             }

             .email-table td.subject-cell,
             .email-table td.sender-cell,
             .email-table td.recipient-cell {
                 white-space: normal !important;
                 text-overflow: clip !important;
                 overflow: visible !important;
                 display: block;
             }

             .email-table td.size-cell {
                 text-align: right;
             }
        }

        /* --- Estilos para el Modal de Advertencia de SPAM --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fdecea;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 850px;
            width: fit-content;
            min-width: 350px;
            text-align: center;
            position: relative;
        }

        .modal-message {
            font-size: 1.1em;
            color: #721c24;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>

    <h1>Explorador de Correos Electrónicos Respaldados</h1>

    <div class="filter-bar">
        <label for="filterSubject">Asunto:</label>
        <input type="text" id="filterSubject" placeholder="Ej: Aviso de Cuenta">

        <label for="filterSender">Remitente:</label>
        <input type="text" id="filterSender" placeholder="Ej: Google o Gmail">

        <label for="filterRecipient">Buzón:</label> <select id="filterRecipient">
            <option value="">Todos</option>
        </select>

        <label for="filterDate">Fecha de recibido:</label>
        <input type="date" id="filterDate">

        <button id="applyFilterBtn">Aplicar Filtro</button>
    </div>

    <div class="pagination">
        <button id="prevPageBtn">Anterior</button>
        <span>Página <input type="number" id="currentPageInput" class="page-input" value="1" min="1"> <span id="totalPagesSpan">de 1</span></span> <button id="nextPageBtn">Siguiente</button>

         <label for="itemsPerPage">Correos Electrónicos por página:</label>
        <select id="itemsPerPage">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>


    <table class="email-table">
        <thead>
            <tr>
                <th>Fecha y Hora</th>
                <th>Asunto</th>
                <th>Remitente</th>
                <th>Destinatario</th>
                <th>Tamaño</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="email-list-body">
            </tbody>
    </table>

    <div class="pagination">
        <button id="prevPageBtn">Anterior</button>
        <span>Página <input type="number" id="currentPageInput" class="page-input" value="1" min="1"> <span id="totalPagesSpan">de 1</span></span>
        <button id="nextPageBtn">Siguiente</button>

         <label for="itemsPerPage">Correos Electrónicos por página:</label>
        <select id="itemsPerPage">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingMessage">Cargando Correos Electrónicos...</p>
    </div>

    <div class="modal-overlay" id="spamModalOverlay">
        <div class="modal-content">
            <p class="modal-message" id="spamModalMessage"></p>
            <div class="modal-buttons">
                <button id="viewSpamButton" style="background-color: #e74c3c; color: white;">Ver de todos modos</button>
                <button id="cancelViewButton" style="background-color: #bdc3c7; color: #333;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- Variables Globales ---
        // Almacena todos los metadatos de correos cargados del servidor.
        let allEmails = [];
        // Almacena los correos después de aplicar filtros.
        let filteredEmails = [];
        // Número de la página actual mostrada.
        let currentPage = 1;
        // Número de correos a mostrar por página, inicializado desde el selector.
        // NOTA: Se usa querySelectorAll y se toma el primer elemento ya que hay dos bloques de paginación.
        let emailsPerPage = parseInt(document.querySelectorAll('.pagination #itemsPerPage')[0].value);


        // --- Referencias a Elementos del DOM ---
        // Cuerpo de la tabla donde se listan los correos.
        const emailListBody = document.getElementById('email-list-body');
        // Input para la página actual.
        // NOTA: Se usa querySelectorAll y se toma el primer elemento ya que hay dos inputs con el mismo ID.
        const currentPageInputs = document.querySelectorAll('.pagination #currentPageInput'); 
        // Span para el total de páginas.
        // NOTA: Se usa querySelectorAll y se toma el primer elemento ya que hay dos spans con el mismo ID.
        const totalPagesSpans = document.querySelectorAll('.pagination #totalPagesSpan'); 
        // Botones para ir a la página anterior.
        const prevPageBtns = document.querySelectorAll('.pagination #prevPageBtn');
        // Botones para ir a la página siguiente.
        const nextPageBtns = document.querySelectorAll('.pagination #nextPageBtn');
        // Selectores para cambiar la cantidad de correos por página.
        const itemsPerPageSelects = document.querySelectorAll('.pagination #itemsPerPage');

        // Elemento del indicador de carga.
        const loadingElement = document.getElementById('loading');
        // Párrafo dentro del indicador de carga para mostrar mensajes.
        const loadingMessageElement = document.getElementById('loadingMessage');

        // Campos de entrada y selector para filtrar.
        const filterSubjectInput = document.getElementById('filterSubject'); // Campo de texto para filtrar por asunto.
        const recipientFilterSelect = document.getElementById('filterRecipient'); // Selector para filtrar por destinatario (buzón POP3).
        const senderInput = document.getElementById('filterSender'); // Campo de texto para filtrar por remitente.
        const dateInput = document.getElementById('filterDate'); // Campo de entrada de fecha para filtrar por fecha.
        const applyFilterButton = document.getElementById('applyFilterBtn'); // Botón para aplicar los filtros.

        // Elementos del Modal de Advertencia de SPAM
        const spamModalOverlay = document.getElementById('spamModalOverlay'); // El fondo oscuro del modal.
        const spamModalMessage = document.getElementById('spamModalMessage'); // El párrafo donde se muestra el mensaje.
        const viewSpamButton = document.getElementById('viewSpamButton'); // Botón "Ver de todos modos".
        const cancelViewButton = document.getElementById('cancelViewButton'); // Botón "Cancelar".

        // Variables para gestionar la acción pendiente del modal de SPAM.
        let currentSpamActionType = null; // Almacena el tipo de acción SPAM: 'view' o 'download'.
        let currentSpamActionArgs = null; // Almacena los argumentos para la acción SPAM (e.g., path, filename).

        // --- Event Listeners ---
        // Asocia la función changePage a los clics en los botones de paginación "Anterior".
        prevPageBtns.forEach(btn => {
            btn.addEventListener('click', () => changePage(-1));
        });
        // Asocia la función changePage a los clics en los botones de paginación "Siguiente".
        nextPageBtns.forEach(btn => {
            btn.addEventListener('click', () => changePage(1));
        });

        // Asocia la función changeItemsPerPage a los cambios en los selectores de elementos por página.
        itemsPerPageSelects.forEach(select => {
            select.addEventListener('change', changeItemsPerPage);
        });

        // NUEVO: Asocia la función goToPageFromInput al cambio en el input de número de página.
        currentPageInputs.forEach(input => {
            input.addEventListener('change', goToPageFromInput);
        });


        // Asocia la función handleApplyFilters al clic en el botón "Aplicar Filtro".
        if (applyFilterButton) {
            applyFilterButton.addEventListener('click', handleApplyFilters);
        } else {
            console.error("[ERROR_FRONTEND] El botón 'Aplicar Filtro' (ID: applyFilterBtn) no se encontró en el DOM. La funcionalidad de filtro no estará disponible.");
        }

        // Event Listeners para los botones del modal de SPAM
        if (viewSpamButton) {
            viewSpamButton.addEventListener('click', handleSpamActionConfirm);
        }
        if (cancelViewButton) {
            cancelViewButton.addEventListener('click', hideSpamWarningModal);
        }

        // --- Funciones de Utilidad para el Mensaje de Carga ---

        /**
         * Muestra el indicador de carga en la parte inferior derecha de la pantalla.
         * @param {string} message - El mensaje a mostrar en el indicador de carga.
         */
        function showLoading(message = 'Cargando...') {
            loadingMessageElement.textContent = message;
            loadingElement.style.display = 'flex';
            console.debug(`[DEBUG_FRONTEND] Indicador de carga mostrado con mensaje: "${message}".`);
        }

        /**
         * Oculta el indicador de carga.
         */
        function hideLoading() {
            loadingElement.style.display = 'none';
            console.debug('[DEBUG_FRONTEND] Indicador de carga oculto.');
        }

        /**
         * Actualiza el texto del mensaje dentro del indicador de carga.
         * @param {string} message - El nuevo mensaje a mostrar.
         */
        function updateLoadingMessage(message) {
            loadingMessageElement.textContent = message;
            console.debug(`[DEBUG_FRONTEND] Mensaje de carga actualizado a: "${message}".`);
        }


        // --- Carga y Procesamiento de Datos ---

        /**
         * Carga asíncronamente todos los metadatos de correos desde el servidor.
         * Esta es la función principal que se ejecuta al cargar la página.
         */
        async function loadAllEmailsForFiltering() {
            showLoading('Cargando Correos Electrónicos...');
            try {
                // Realiza una petición GET al endpoint /list-eml para obtener los metadatos de los correos.
                const response = await fetch('/list-eml');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                updateLoadingMessage('Procesando datos recibidos...');
                const data = await response.json();
                allEmails = data.emails || [];

                console.info(`[INFO_FRONTEND] ${allEmails.length} metadatos de correos cargados exitosamente del servidor.`);

                // Llena el selector de destinatarios (buzones POP3) con los destinatarios únicos encontrados.
                populateRecipientFilter(allEmails);

                // Aplica los filtros iniciales (muestra todos por defecto) y carga la primera página.
                handleApplyFilters();

            } catch (error) {
                console.error('[ERROR_FRONTEND] Fallo crítico al cargar los metadatos de correos desde el servidor:', error);
                emailListBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No se pudieron cargar los Correos Electrónicos. Por favor, verifica la consola del navegador para más detalles.</td></tr>`;
                allEmails = [];
                filteredEmails = [];
                updatePaginationControls();
                updateLoadingMessage('Error al cargar correos.');
                hideLoading();
            }
        }

        /**
         * Llena el selector de destinatarios (buzones POP3) con opciones únicas basadas en los correos cargados.
         * Esto permite al usuario filtrar correos por el buzón POP3 al que llegaron.
         * @param {Array<Object>} emails - La lista de objetos de correo cargados.
         */
        function populateRecipientFilter(emails) {
            // Extrae todos los destinatarios (buzones POP3), elimina duplicados y filtra valores nulos o vacíos.
            const recipients = [...new Set(emails.map(email => email.recipient).filter(Boolean))];
            recipients.sort(); // Ordena alfabéticamente para una mejor usabilidad.

            // Limpia las opciones actuales del selector, manteniendo solo la opción predeterminada "Todos".
            recipientFilterSelect.innerHTML = '<option value="">Todos</option>';

            // Añade una nueva opción al selector por cada destinatario único encontrado.
            recipients.forEach(recipient => {
                const option = document.createElement('option');
                option.value = recipient;
                option.textContent = recipient;
                recipientFilterSelect.appendChild(option);
            });
            console.info(`[INFO_FRONTEND] Selector de buzones poblado con ${recipients.length} buzones únicos.`);
        }


        // --- Lógica de Filtrado y Paginación ---

        /**
         * Aplica los filtros de búsqueda (asunto, remitente, destinatario, fecha) a todos los correos cargados.
         * Actualiza la lista 'filteredEmails' con los resultados y reinicia la paginación a la primera página.
         */
        function applyFilters() {
             showLoading('Aplicando filtros...');
            // Obtiene los valores de los campos de filtro y los convierte a minúsculas para una búsqueda insensible a mayúsculas/minúsculas.
            const subjectTerm = filterSubjectInput.value.toLowerCase();
            const senderTerm = senderInput.value.toLowerCase();
            const selectedRecipient = recipientFilterSelect.value; // Obtiene el destinatario (buzón POP3) seleccionado.
            const selectedDate = dateInput.value; // Obtiene la fecha seleccionada en formato interminable-MM-DD.

            // Filtra la lista completa de correos ('allEmails') basándose en los criterios de búsqueda.
            filteredEmails = allEmails.filter(email => {
                const matchesSubject = subjectTerm === '' || (email.subject && email.subject.toLowerCase().includes(subjectTerm));
                const matchesSender = senderTerm === '' || (email.sender && email.sender.toLowerCase().includes(senderTerm));
                const matchesRecipient = selectedRecipient === '' || (email.recipient && email.recipient === selectedRecipient);
                // Asume que email.date está en formato DD-MM-AAAA y lo convierte a interminable-MM-DD para comparación.
                const matchesDate = selectedDate === '' || (email.date && email.date.split('-').reverse().join('-') === selectedDate);

                // Un correo se incluye en los resultados filtrados si cumple con TODOS los criterios de filtro.
                return matchesSubject && matchesSender && matchesRecipient && matchesDate;
            });

            // Ordena la lista filtrada por fecha y hora en orden descendente (los correos más recientes primero).
             filteredEmails.sort((a, b) => {
                 // Construye una cadena comparable en formato AAAAMMDDHHmm a partir de DD-MM-AAAA y HH-mm.
                 const dateA = (a.date && a.time) ? `${a.date.split('-')[2]}${a.date.split('-')[1]}${a.date.split('-')[0]}${a.time.replace('-', '')}` : '0';
                 const dateB = (b.date && b.time) ? `${b.date.split('-')[2]}${b.date.split('-')[1]}${b.date.split('-')[0]}${b.time.replace('-', '')}` : '0';

                 if (dateA < dateB) return 1;
                 if (dateA > dateB) return -1;
                 return 0;
             });

            console.info(`[INFO_FRONTEND] Filtros aplicados. ${filteredEmails.length} correos coinciden con los criterios.`);

            currentPage = 1; // Reinicia la paginación a la primera página después de aplicar nuevos filtros.
            displayCurrentPageEmails(); // Muestra los correos de la primera página.
            window.scrollTo(0, 0); // Desplázate al inicio de la página para que el usuario vea la primera página de resultados.
            hideLoading();
        }

        /**
         * Maneja el evento de clic en el botón "Aplicar Filtro".
         * Esta función inicia el proceso de filtrado y actualización de la tabla.
         */
         function handleApplyFilters() {
             console.debug('[DEBUG_FRONTEND] Botón "Aplicar Filtro" clickeado. Iniciando proceso de filtrado.');
             applyFilters();
         }


        /**
         * Muestra los correos correspondientes a la página actual en la tabla HTML.
         * Calcula qué correos mostrar basándose en 'currentPage' y 'emailsPerPage'.
         */
        function displayCurrentPageEmails() {
             showLoading('Mostrando página de correos...');
            // Calcula los índices de inicio y fin para obtener el subconjunto de correos de la página actual.
            const startIndex = (currentPage - 1) * emailsPerPage;
            const endIndex = startIndex + emailsPerPage;
            const emailsToDisplay = filteredEmails.slice(startIndex, endIndex);

            // Limpia el contenido actual del cuerpo de la tabla.
            emailListBody.innerHTML = '';

            if (emailsToDisplay.length === 0) {
                const noResultsRow = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6; /* Mantiene colspan en 6 para la tabla principal */
                cell.textContent = 'No se encontraron correos electrónicos que coincidan con los filtros.';
                cell.style.textAlign = 'center';
                noResultsRow.appendChild(cell);
                emailListBody.appendChild(noResultsRow);
                console.info('[INFO_FRONTEND] No hay correos para mostrar en la página actual o no coinciden con los filtros.');
            } else {
                // Itera sobre los correos a mostrar y crea una fila de tabla para cada uno.
                emailsToDisplay.forEach(email => {
                    const row = document.createElement('tr');

                    // Utiliza el campo 'is_spam' determinado por el servidor.
                    const determinedIsSpam = email.is_spam === true; 

                    // Argumentos para las funciones de visualización/descarga, para el mensaje del modal.
                    const spamScoreForModal = email.spam_score;
                    const spamFilterWhitelistStatus = email.spam_filter_whitelist ? email.spam_filter_whitelist.toLowerCase() : 'no';

                    // Añade la clase 'is-spam' a la fila si el correo es spam según el servidor.
                    if (determinedIsSpam) {
                        row.classList.add('is-spam');
                    }
                    const encodedPath = encodeURIComponent(email.path); // Codifica la ruta para URL.

                    row.innerHTML = `
                        <td data-label="Fecha y Hora:" class="datetime-cell">${formatDate(email.date)} ${formatTime(email.time)}</td>
                        <td data-label="Asunto:" class="subject-cell" title="${escapeHTML(email.subject)}">${escapeHTML(email.subject)}</td>
                        <td data-label="Remitente:" class="sender-cell" title="${escapeHTML(email.sender)}">${escapeHTML(email.sender)}</td>
                        <td data-label="Destinatario:" class="recipient-cell" title="${escapeHTML(email.recipient)}">${escapeHTML(email.recipient)}</td>
                        <td data-label="Tamaño:" class="size-cell">${formatBytes(email.tamano_eml)}</td>
                        <td data-label="Acciones:" class="actions-cell">
                            <button class="view-button" onclick="viewEmail('${encodedPath}', ${determinedIsSpam}, ${spamScoreForModal === null || spamScoreForModal === undefined ? 'null' : spamScoreForModal}, '${spamFilterWhitelistStatus}')">Ver</button>
                            <button class="download-button" onclick="downloadEmail('${encodedPath}', '${escapeHTML(email.name)}', ${determinedIsSpam}, ${spamScoreForModal === null || spamScoreForModal === undefined ? 'null' : spamScoreForModal}, '${spamFilterWhitelistStatus}')">Descargar</button>
                        </td>
                    `;
                    emailListBody.appendChild(row);
                });
                console.info(`[INFO_FRONTEND] Mostrando ${emailsToDisplay.length} correos en la página ${currentPage}.`);
            }

            updatePaginationControls(); // Actualiza el estado de los controles de paginación.
            hideLoading();
        }

        /**
         * Actualiza el texto de información de la página y habilita/deshabilita los botones de paginación.
         * Esto refleja la página actual y el número total de páginas disponibles.
         */
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredEmails.length / emailsPerPage);
            
            // Actualiza el input de la página actual y el span del total de páginas para AMBOS bloques de paginación.
            currentPageInputs.forEach(input => {
                input.value = currentPage;
                input.max = totalPages > 0 ? totalPages : 1; // Establece el máximo para el input de página.
            });
            totalPagesSpans.forEach(span => {
                span.textContent = `de ${totalPages || 1}`;
            });

            // Habilita o deshabilita los botones "Anterior" para AMBOS bloques de paginación.
            prevPageBtns.forEach(btn => {
                btn.disabled = currentPage === 1 || filteredEmails.length === 0;
            });
            // Habilita o deshabilita los botones "Siguiente" para AMBOS bloques de paginación.
            nextPageBtns.forEach(btn => {
                btn.disabled = currentPage >= totalPages || filteredEmails.length === 0;
            });
            console.debug(`[DEBUG_FRONTEND] Controles de paginación actualizados. Página actual: ${currentPage}, Total de páginas: ${totalPages || 1}.`);
        }

        /**
         * Cambia la página actual mostrada en la tabla.
         * Se llama al hacer clic en los botones "Anterior" o "Siguiente".
         * @param {number} direction - La dirección del cambio (-1 para ir a la página anterior, 1 para ir a la página siguiente).
         */
        function changePage(direction) {
            const totalPages = Math.ceil(filteredEmails.length / emailsPerPage);
            const newPage = currentPage + direction;

            // Verifica si la nueva página propuesta está dentro del rango válido.
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                console.info(`[INFO_FRONTEND] Cambiando a la página ${currentPage}.`);
                displayCurrentPageEmails();
                window.scrollTo(0, 0); // Desplázate al inicio de la página.
            } else {
                console.debug(`[DEBUG_FRONTEND] Intento de cambiar a una página inválida: ${newPage}. Página actual: ${currentPage}, Total de páginas: ${totalPages || 1}.`);
            }
        }

        /**
         * NUEVO: Maneja la entrada directa del número de página por parte del usuario.
         * Valida la entrada y navega a la página si es válida.
         */
        function goToPageFromInput(event) {
            let newPage = parseInt(event.target.value); // Obtiene el valor del input que disparó el evento.
            const totalPages = Math.ceil(filteredEmails.length / emailsPerPage);

            // Valida la entrada: si no es un número, o es menor que 1, establece a 1.
            if (isNaN(newPage) || newPage < 1) {
                newPage = 1;
                console.warn('[WARN_FRONTEND] Entrada de página inválida. Se ha ajustado a la página 1.');
            }
            // Si la página excede el total de páginas (y hay correos), ajusta al total de páginas.
            if (newPage > totalPages && totalPages > 0) {
                newPage = totalPages;
                console.warn(`[WARN_FRONTEND] La página solicitada excede el total de páginas. Se ha ajustado a la página ${totalPages}.`);
            }
            // Si no hay correos, la página siempre es 1.
            if (filteredEmails.length === 0) {
                newPage = 1;
            }

            // Si la nueva página es diferente a la actual, actualiza y muestra.
            if (newPage !== currentPage) {
                currentPage = newPage;
                console.info(`[INFO_FRONTEND] Navegando directamente a la página: ${currentPage}.`);
                displayCurrentPageEmails();
                window.scrollTo(0, 0);
            } else {
                // Si el usuario escribe el número de página actual, simplemente asegura que el input refleje el valor correcto.
                // Se actualizan todos los inputs de página para que estén sincronizados.
                currentPageInputs.forEach(input => {
                    input.value = currentPage;
                });
                console.debug('[DEBUG_FRONTEND] El usuario ingresó la página actual. No se requiere recarga.');
            }
        }

        /**
         * Maneja el cambio en el número de elementos a mostrar por página seleccionado por el usuario.
         * Se llama cuando el usuario selecciona un nuevo valor en el selector "Correos Electrónicos por página".
         * @param {Event} event - El evento de cambio disparado por el selector.
         */
        function changeItemsPerPage(event) {
            showLoading('Actualizando número de correos por página...');
            const newItemsPerPage = parseInt(event.target.value);
            emailsPerPage = newItemsPerPage;
            console.info(`[INFO_FRONTEND] Número de correos por página cambiado a: ${emailsPerPage}.`);

            // Sincroniza el valor seleccionado en ambos selectores de paginación.
            itemsPerPageSelects.forEach(select => {
                select.value = newItemsPerPage;
            });

            currentPage = 1; // Siempre vuelve a la primera página.
            displayCurrentPageEmails();
            window.scrollTo(0, 0);
            hideLoading();
        }


        // --- Funciones de Acción de Correo ---

        /**
         * Inicia el proceso para abrir el contenido de un archivo .eml en una nueva pestaña.
         * Si el correo está marcado como spam, muestra un modal de advertencia antes de proceder.
         * @param {string} encodedPath - La ruta relativa del archivo .eml a visualizar, ya codificada con encodeURIComponent.
         * @param {boolean} isSpam - Indica si el correo está marcado como spam (true) o no (false).
         * @param {number|null} spamScore - La puntuación de spam del correo, o null si no está disponible.
         * @param {string} spamFilterWhitelistStatus - Estado de la lista blanca de spam ('yes' o 'no').
         */
        function viewEmail(encodedPath, isSpam, spamScore, spamFilterWhitelistStatus) {
            console.debug(`[DEBUG_FRONTEND] Intentando visualizar correo. Path: '${encodedPath}', SPAM: ${isSpam}, Score: ${spamScore}, Whitelist: '${spamFilterWhitelistStatus}'.`);
            if (isSpam) {
                currentSpamActionType = 'view';
                currentSpamActionArgs = { path: encodedPath };
                // Muestra el modal de advertencia con el mensaje y la puntuación de spam.
                showSpamWarningModal('Alerta de Seguridad.<br>Este Correo Electrónico está marcado como SPAM.<br>' + 
                                     (spamScore !== null && spamScore !== undefined ? 'Puntuación de Spam: ' + spamScore + '<br>' : '') +
                                     'Abrirlo podría exponer su dispositivo a software malicioso o revelar información personal.<br>¿Desea continuar bajo su propio riesgo?');
            } else {
                openEmailPreview(encodedPath);
            }
        }

        /**
         * Muestra el modal de advertencia de SPAM con el mensaje proporcionado.
         * Configura el texto del botón de confirmación según la acción pendiente ('view' o 'download').
         * @param {string} message - El mensaje HTML a mostrar dentro del modal.
         */
        function showSpamWarningModal(message) {
            spamModalMessage.innerHTML = message;
            if (currentSpamActionType === 'download') {
                viewSpamButton.textContent = 'Descargar de todos modos';
            } else {
                viewSpamButton.textContent = 'Ver de todos modos';
            }
            spamModalOverlay.style.display = 'flex';
            console.warn('[WARN_FRONTEND] Modal de advertencia de SPAM mostrado al usuario.');
        }

        /**
         * Oculta el modal de advertencia de SPAM y reinicia las variables de acción pendiente.
         */
        function hideSpamWarningModal() {
            spamModalOverlay.style.display = 'none';
            currentSpamActionType = null;
            currentSpamActionArgs = null;
            console.debug('[DEBUG_FRONTEND] Modal de advertencia de SPAM oculto y estado reiniciado.');
        }

        /**
         * Abre una nueva pestaña del navegador para mostrar la vista previa HTML de un archivo .eml.
         * Se llama después de confirmar la acción (si el correo era spam) o directamente si no era spam.
         * @param {string} encodedPath - La ruta relativa del archivo .eml a visualizar, ya codificada con encodeURIComponent.
         */
        function openEmailPreview(encodedPath) {
            console.debug(`[DEBUG_FRONTEND] Intentando abrir vista previa para la ruta codificada: '${encodedPath}'.`);
            if (!encodedPath || typeof encodedPath !== 'string' || encodedPath.trim() === "" || encodedPath === "undefined" || encodedPath === "null") {
                console.error('[ERROR_FRONTEND] La ruta codificada proporcionada para la vista previa es inválida o está vacía.');
                alert("Error: No se puede abrir la vista previa porque la ruta del archivo es inválida. Por favor, verifica los metadatos del Correo Electrónico.");
                return;
            }

            const viewUrl = `/view-html-eml?path=${encodedPath}`;
            const newWindow = window.open(viewUrl, '_blank');

            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                console.warn('[WARN_FRONTEND] El navegador pudo haber bloqueado la apertura de la nueva ventana (pop-up) para la vista previa. URL intentada:', viewUrl);
                alert('La vista previa del correo no se pudo abrir. Es posible que tu navegador haya bloqueado la ventana emergente. Por favor, revisa la configuración de tu bloqueador de pop-ups.');
            } else {
                console.info('[INFO_FRONTEND] Se intentó abrir una nueva ventana para la vista previa del correo.');
            }
        }

        /**
         * Maneja el clic en el botón de confirmación ("Ver de todos modos" o "Descargar de todos modos") del modal de SPAM.
         * Ejecuta la acción pendiente (visualizar o descargar) si el usuario confirma.
         */
        function handleSpamActionConfirm() {
            console.debug(`[DEBUG_FRONTEND] Confirmación de acción SPAM. Tipo: '${currentSpamActionType}', Argumentos:`, currentSpamActionArgs);
            if (currentSpamActionType === 'view' && currentSpamActionArgs && currentSpamActionArgs.path) {
                openEmailPreview(currentSpamActionArgs.path);
            } else if (currentSpamActionType === 'download' && currentSpamActionArgs && currentSpamActionArgs.path && currentSpamActionArgs.filename) {
                performActualDownload(currentSpamActionArgs.path, currentSpamActionArgs.filename);
            } else {
                console.error('[ERROR_FRONTEND] Tipo de acción o argumentos no válidos para la confirmación de SPAM.');
                alert("Error: No se pudo determinar qué Correo Electrónico visualizar/descargar. Por favor, intenta de nuevo.");
            }
            hideSpamWarningModal();
        }

        /**
         * Inicia el proceso para descargar un archivo .eml específico desde el servidor.
         * Si el correo es spam, muestra un modal de advertencia antes de proceder con la descarga.
         * @param {string} encodedPath - La ruta relativa del archivo .eml a descargar, ya codificada con encodeURIComponent.
         * @param {string} originalFilename - El nombre original del archivo para la descarga.
         * @param {boolean} isSpam - Indica si el correo está marcado como spam.
         * @param {number|null} spamScore - La puntuación de spam del correo, o null si no está disponible.
         * @param {string} spamFilterWhitelistStatus - Estado de la lista blanca de spam ('yes' o 'no').
         */
        function downloadEmail(encodedPath, originalFilename, isSpam, spamScore, spamFilterWhitelistStatus) {
            console.debug(`[DEBUG_FRONTEND] Intentando descargar correo. Path: '${encodedPath}', Nombre: '${originalFilename}', SPAM: ${isSpam}, Score: ${spamScore}, Whitelist: '${spamFilterWhitelistStatus}'.`);
            if (isSpam) {
                currentSpamActionType = 'download';
                currentSpamActionArgs = { path: encodedPath, filename: originalFilename };
                // Muestra el modal de advertencia con el mensaje y la puntuación de spam.
                showSpamWarningModal('Alerta de Seguridad.<br>Este Correo Electrónico está marcado como SPAM.<br>' + 
                                     (spamScore !== null && spamScore !== undefined ? 'Puntuación de Spam: ' + spamScore + '<br>' : '') +
                                     'Descargarlo podría exponer su dispositivo a software malicioso o revelar información personal.<br>¿Desea continuar bajo su propio riesgo?');
            } else {
                performActualDownload(encodedPath, originalFilename);
            }
        }

        /**
         * Realiza la descarga efectiva del archivo .eml creando un enlace temporal y simulando un clic.
         * Se llama después de confirmar la acción (si el correo era spam) o directamente si no era spam.
         * @param {string} encodedPath - La ruta relativa del archivo .eml a descargar, ya codificada.
         * @param {string} originalFilename - El nombre original del archivo para la descarga.
         */
        function performActualDownload(encodedPath, originalFilename) {
            console.debug(`[DEBUG_FRONTEND] Iniciando descarga efectiva para archivo: '${originalFilename}' (Path: '${encodedPath}').`);
            const link = document.createElement('a');
            link.href = `/download-eml?path=${encodedPath}`;
            link.download = originalFilename;
            link.click();
            console.info(`[INFO_FRONTEND] Solicitud de descarga iniciada para el archivo: '${originalFilename}'.`);
        }

        // --- Funciones Auxiliares ---

        /**
         * Formatea una cadena de fecha de "DD-MM-AAAA" a "DD/MM/AAAA".
         * @param {string} dateStr - La cadena de fecha en formato "DD-MM-AAAA".
         * @returns {string} La fecha formateada o 'Fecha desconocida' si la entrada es nula o vacía.
         */
        function formatDate(dateStr) {
            if (!dateStr) {
                console.warn('[WARN_FRONTEND] formatDate: Cadena de fecha inválida o vacía recibida.');
                return 'Fecha desconocida';
            }
            return dateStr.replace(/-/g, '/');
        }

        /**
         * Formatea una cadena de hora de "HH-mm" a "HH:mm".
         * @param {string} timeStr - La cadena de hora en formato "HH-mm".
         * @returns {string} La hora formateada o 'Hora desconocida' si la entrada es nula o vacía.
         */
        function formatTime(timeStr) {
             if (!timeStr) {
                 console.warn('[WARN_FRONTEND] formatTime: Cadena de hora inválida o vacía recibida.');
                 return 'Hora desconocida';
             }
            return timeStr.replace('-', ':');
        }

        /**
         * Formatea un tamaño en bytes a un formato legible (Bytes, KB, MB, etc.).
         * @param {number} bytes - El tamaño en bytes.
         * @param {number} decimals - El número de decimales a mostrar. Por defecto es 2.
         * @returns {string} El tamaño formateado con su unidad o 'Tamaño desconocido' si la entrada es nula, indefinida o 0.
         */
        function formatBytes(bytes, decimals = 2) {
            if (bytes === undefined || bytes === null || typeof bytes !== 'number' || bytes < 0) {
                 console.warn('[WARN_FRONTEND] formatBytes: Entrada inválida o negativa recibida:', bytes);
                 return 'Tamaño desconocido';
            }
             if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        /**
         * Escapa caracteres HTML especiales en una cadena de texto para prevenir ataques de Cross-Site Scripting (XSS).
         * Esto es crucial al mostrar contenido generado por el servidor o por el usuario directamente en el HTML.
         * @param {string} str - La cadena de texto a escapar.
         * @returns {string} La cadena con caracteres HTML escapados o una cadena vacía si la entrada es nula o vacía.
         */
        function escapeHTML(str) {
            if (!str || typeof str !== 'string') {
                 console.warn('[WARN_FRONTEND] escapeHTML: Entrada inválida o no es una cadena recibida.');
                 return '';
            }
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // --- Inicialización ---
        // Inicia la carga de los metadatos de correos cuando la página HTML se haya cargado completamente.
        window.onload = loadAllEmailsForFiltering;
    </script>
</body>
</html>
